<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Transaksi Penjualan</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    body {
      background: linear-gradient(to right, #ffe6cc, #ffd699);
      font-family: 'Segoe UI', sans-serif;
    }
    h1 {
      color: #6f4e37;
      font-weight: bold;
      text-shadow: 1px 1px 2px #fff0e6;
    }
    .card-produk {
      border-radius: 15px;
      border: none;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .card-produk:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(0,0,0,0.25);
    }
    .btn-primary {
      background: linear-gradient(90deg, #d2691e, #ff7f50);
      border: none;
      transition: 0.3s;
    }
    .btn-primary:hover {
      background: linear-gradient(90deg, #b55215, #ff6347);
    }
    .btn-success {
      background: linear-gradient(90deg, #8b4513, #a0522d);
      border: none;
      transition: 0.3s;
    }
    .btn-success:hover {
      background: linear-gradient(90deg, #6b3310, #7a3f12);
    }
    .btn-danger {
      transition: 0.3s;
    }
    .table thead {
      background-color: #a0522d;
      color: #fff;
    }
    .table tfoot {
      background-color: #ffe4c4;
      font-weight: bold;
    }
    .nama-user {
      font-weight: bold;
      color: #6f4e37;
    }
    .badge-stok {
      font-size: 0.85rem;
      padding: 0.4em 0.7em;
      border-radius: 12px;
      font-weight: 600;
    }
    .search-input {
      max-width: 350px;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .produk-name {
      font-weight: bold;
      font-size: 1rem;
      color: #4b2e2e;
    }
    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  </style>
</head>
<body>
<div class="container py-5">
  <h1 class="mb-4 text-center">ðŸ’° Transaksi Penjualan</h1>

  <!-- Search -->
  <input type="text" id="searchProduk" class="form-control search-input" placeholder="ðŸ” Cari produk..." onkeyup="renderProduk()">

  <!-- Daftar Produk -->
  <div class="row" id="produk-list"></div>

  <!-- Tabel Keranjang -->
  <div class="card p-4 mt-5 shadow-sm">
    <h4 class="mb-3">ðŸ›’ Keranjang</h4>
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead>
          <tr>
            <th>Produk</th>
            <th>Jumlah</th>
            <th>Harga</th>
            <th>Subtotal</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="keranjang"></tbody>
        <tfoot>
          <tr>
            <td colspan="3" class="text-end"><strong>Total</strong></td>
            <td colspan="2"><strong>Rp <span id="total">0</span></strong></td>
          </tr>
        </tfoot>
      </table>
    </div>
    <div class="card-footer">
      <div class="d-flex gap-2">
        <button class="btn btn-success" onclick="simpanTransaksi()"><i class="fa-solid fa-floppy-disk"></i> Simpan</button>
        <button class="btn btn-danger" onclick="resetKeranjang()"><i class="fa-solid fa-trash"></i> Reset</button>
      </div>
      <span class="nama-user">Jeshiel Gaudete Sitompul</span>
    </div>
  </div>
</div>

<script>
  const SUPABASE_URL = "https://rambdwebvduwxskzvxpf.supabase.co";
  const SUPABASE_KEY = "YOUR_SUPABASE_KEY"; 
  const { createClient } = supabase;
  const db = createClient(SUPABASE_URL, SUPABASE_KEY);

  let produkList = [];
  let keranjang = [];
  let total = 0;

  async function loadProduk() {
    const { data, error } = await db.from("produk").select("*").order("nama", { ascending: true });
    if (error) return Swal.fire("Error", error.message, "error");
    produkList = data;
    renderProduk();
  }

  function renderProduk() {
    const list = document.getElementById("produk-list");
    const search = document.getElementById("searchProduk").value.toLowerCase();
    list.innerHTML = "";

    produkList.filter(p => p.nama.toLowerCase().includes(search)).forEach(p => {
      let stokClass = p.stok <= 5 ? "badge bg-danger badge-stok" : "badge bg-success badge-stok";
      let col = document.createElement("div");
      col.className = "col-md-3 mb-4";
      col.innerHTML = `
        <div class="card card-produk p-3 h-100">
          <h6 class="produk-name">${p.nama}</h6>
          <p class="mb-1">Harga: <strong>Rp ${p.harga.toLocaleString()}</strong></p>
          <p>Stok: <span id="stok-${p.id}" class="${stokClass}">${p.stok}</span></p>
          <input type="number" id="qty-${p.id}" class="form-control mb-2" placeholder="Jumlah" min="1" max="${p.stok}">
          <button class="btn btn-primary w-100" onclick="tambahDetailCard(${p.id})"><i class="fa-solid fa-cart-plus"></i> Tambah</button>
        </div>
      `;
      list.appendChild(col);
    });
  }

  function tambahDetailCard(id_produk) {
    let produk = produkList.find(p => p.id === id_produk);
    let jumlah = parseInt(document.getElementById(`qty-${id_produk}`).value);
    if (!jumlah || jumlah <= 0) return Swal.fire("Oops!", "Masukkan jumlah valid", "warning");
    if (jumlah > produk.stok) return Swal.fire("Oops!", `Stok hanya ${produk.stok}`, "warning");

    let subtotal = produk.harga * jumlah;
    keranjang.push({ id_produk, nama: produk.nama, harga: produk.harga, jumlah, subtotal });
    total += subtotal;
    renderKeranjang();
    document.getElementById(`qty-${id_produk}`).value = "";
  }

  function renderKeranjang() {
    const tbody = document.getElementById("keranjang");
    tbody.innerHTML = "";
    keranjang.forEach((item, i) => {
      let tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.nama}</td>
        <td>${item.jumlah}</td>
        <td>Rp ${item.harga.toLocaleString()}</td>
        <td>Rp ${item.subtotal.toLocaleString()}</td>
        <td><button class="btn btn-danger btn-sm" onclick="hapusItem(${i})"><i class="fa-solid fa-trash"></i></button></td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById("total").textContent = total.toLocaleString();
  }

  function hapusItem(index) {
    total -= keranjang[index].subtotal;
    keranjang.splice(index, 1);
    renderKeranjang();
  }

  function resetKeranjang() {
    keranjang = [];
    total = 0;
    renderKeranjang();
  }

  async function simpanTransaksi() {
    if (keranjang.length === 0) return Swal.fire("Oops!", "Keranjang kosong", "warning");

    const { data: penjualan, error: err1 } = await db.from("penjualan").insert([{ tanggal: new Date().toISOString(), total }]).select("id").single();
    if (err1) return Swal.fire("Error", err1.message, "error");

    let id_penjualan = penjualan.id;
    let detailInsert = keranjang.map(d => ({ id_penjualan, id_produk: d.id_produk, jumlah: d.jumlah, harga: d.harga, subtotal: d.subtotal }));
    const { error: err2 } = await db.from("penjualan_detail").insert(detailInsert);
    if (err2) return Swal.fire("Error", err2.message, "error");

    for (let item of keranjang) {
      let produk = produkList.find(p => p.id === item.id_produk);
      await db.from("produk").update({ stok: produk.stok - item.jumlah }).eq("id", item.id_produk);
    }

    Swal.fire("Sukses", "Transaksi berhasil disimpan", "success");
    keranjang = []; total = 0;
    renderKeranjang();
    loadProduk();
  }

  loadProduk();
</script>
</body>
</html>
